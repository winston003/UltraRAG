
基于您的要求，我将设计一个完全基于LanceDB的多粒度RAG系统架构，统一处理关键词、稠密和稀疏检索。

## 核心架构设计

### 1. LanceDB统一存储架构

```
LanceDB多模态存储
├── documents_table (文档级表)
│   ├── id (PK)
│   ├── document_id (全局唯一ID)
│   ├── title (文档标题)
│   ├── series (系列名称)
│   ├── lesson_number (课程编号)
│   ├── content_type (内容类型)
│   ├── created_at (创建时间)
│   ├── metadata (JSON元数据)
│   └── summary_vector (文档摘要向量)

├── logical_units_table (逻辑单元表)
│   ├── id (PK)
│   ├── logical_unit_id (逻辑单元ID)
│   ├── document_id (FK)
│   ├── unit_type (单元类型: 章节段落)
│   ├── title (单元标题)
│   ├── summary (单元摘要)
│   ├── keywords (关键词列表)
│   ├── sparse_vector (稀疏向量BM25)
│   └── dense_vector (稠密向量)

└── chunks_table (块级表)
    ├── id (PK)
    ├── chunk_id (块ID)
    ├── logical_unit_id (FK)
    ├── document_id (FK)
    ├── chunk_text (块文本)
    ├── position_start (起始位置)
    ├── position_end (结束位置)
    ├── word_count (词数)
    ├── sparse_vector (稀疏向量BM25)
    ├── dense_vector (稠密向量)
    └── metadata (JSON元数据)
```

### 2. 多粒度索引策略

#### 稠密向量索引

```python
# 在LanceDB中自动创建HNSW索引
dense_index_config = {
    "index_type": "HNSW",
    "metric": "cosine",
    "num_partitions": 256,
    "num_sub_vectors": 64
}
```

#### 稀疏向量索引 (BM25)

```python
# 基于关键词的稀疏向量
sparse_index_config = {
    "index_type": "IVF_FLAT",
    "metric": "l2",
    "num_partitions": 128
}
```

#### 混合索引配置

```python
# LanceDB支持多列索引
hybrid_index_config = {
    "dense_vector": dense_index_config,
    "sparse_vector": sparse_index_config,
    "metadata": ["series", "lesson_number", "content_type"]
}
```

### 3. 检索优化层实现

#### 多阶段检索流程

```python
class MultiStageLanceDBRetriever:
    def __init__(self, db_path: str):
        self.db = lancedb.connect(db_path)
        self.docs_table = self.db.open_table("documents_table")
        self.logical_table = self.db.open_table("logical_units_table")
        self.chunks_table = self.db.open_table("chunks_table")
  
    async def multi_stage_search(self, query: str, filters: dict = None):
        # 第一阶段：文档级过滤
        doc_results = await self.document_filter(query, filters)
      
        # 第二阶段：逻辑单元级检索
        logical_results = await self.logical_unit_search(query, doc_results)
      
        # 第三阶段：块级混合检索
        chunk_results = await self.chunk_hybrid_search(query, logical_results)
      
        return chunk_results
```

#### 混合检索实现

```python
class HybridLanceDBSearch:
    def __init__(self, table):
        self.table = table
  
    async def hybrid_search(self, query, top_k=10):
        # 稠密检索
        dense_query = self.table.search().vector(
            query_embedding, 
            vector_column_name="dense_vector"
        ).limit(top_k * 2)
      
        # 稀疏检索 (BM25)
        sparse_query = self.table.search().vector(
            sparse_embedding, 
            vector_column_name="sparse_vector"
        ).limit(top_k * 2)
      
        # 元数据过滤
        if filters:
            dense_query = dense_query.where(self._build_filter_expr(filters))
            sparse_query = sparse_query.where(self._build_filter_expr(filters))
      
        # 执行查询
        dense_results = dense_query.to_pandas()
        sparse_results = sparse_query.to_pandas()
      
        # RRF融合
        return self._rrf_fusion(dense_results, sparse_results, top_k)
```

### 4. UltraRAG MCP Server集成

#### 扩展Retriever Server

```python
# 在servers/retriever/src/retriever.py中新增工具

@app.tool
def lancedb_multi_granularity_init(
    lancedb_path: str,
    embedding_model: str,
    use_bm25: bool = True
) -> dict:
    """初始化多粒度LanceDB检索器"""
    # 初始化文档表、逻辑单元表、块表
    pass

@app.tool
def lancedb_build_multi_index(
    corpus_path: str,
    chunk_strategy: str = "semantic",
    overwrite: bool = False
) -> dict:
    """构建多粒度索引"""
    # 1. 处理原始文档
    # 2. 提取逻辑单元
    # 3. 动态分块
    # 4. 生成稠密和稀疏向量
    # 5. 构建LanceDB索引
    pass

@app.tool
def lancedb_hybrid_search(
    query: str,
    search_mode: str = "hybrid",  # dense/sparse/hybrid
    filters: dict = None,
    top_k: int = 10
) -> list:
    """混合检索"""
    # 根据模式选择检索策略
    pass
```

### 5. Pipeline配置示例

```yaml
# 基于LanceDB的多粒度RAG配置
servers:
  corpus: servers/corpus
  retriever: servers/retriever
  reranker: servers/reranker
  prompt: servers/prompt
  generation: servers/generation
  evaluation: servers/evaluation

pipeline:
# 1. 数据处理与分层
- corpus.process_documents
- corpus.extract_logical_units
- corpus.create_chunks

# 2. LanceDB多粒度索引构建
- retriever.lancedb_multi_granularity_init
- retriever.lancedb_build_multi_index

# 3. 多阶段检索
- retriever.lancedb_hybrid_search
- reranker.rerank_results
- reranker.expand_context

# 4. 生成与评估
- prompt.qa_rag_boxed
- generation.generate
- evaluation.evaluate
```

### 6. 参数配置

```yaml
# servers/retriever/parameter.yaml
retriever_path: openbmb/MiniCPM-Embedding-Light
corpus_path: data/corpus_example.jsonl

# LanceDB配置
lancedb_path: "lancedb_multi_granularity/"
documents_table: "documents_table"
logical_units_table: "logical_units_table"
chunks_table: "chunks_table"

# 稠密向量配置
dense_index_type: "HNSW"
dense_metric: "cosine"
num_partitions: 256
num_sub_vectors: 64

# 稀疏向量配置 (BM25)
sparse_index_type: "IVF_FLAT"
sparse_metric: "l2"
bm25_k1: 1.2
bm25_b: 0.75

# 检索配置
default_search_mode: "hybrid"  # dense/sparse/hybrid
default_top_k: 10
rrf_k: 60  # RRF融合参数

# 分块配置
chunk_strategy: "semantic"
chunk_size: 512
chunk_overlap: 50
```

## 关键优势

### 1. 统一存储管理

- 所有粒度的数据统一存储在LanceDB中
- 支持事务操作，保证数据一致性
- 内置版本控制和时间旅行功能

### 2. 高性能检索

- HNSW索引支持快速稠密向量检索
- IVF_FLAT索引支持高效稀疏向量检索
- 多列索引支持复合查询

### 3. 灵活的查询策略

```python
# 支持多种检索模式
search_modes = {
    "dense": "仅使用稠密向量检索",
    "sparse": "仅使用稀疏向量检索", 
    "hybrid": "稠密+稀疏混合检索",
    "multi_stage": "多阶段检索"
}
```

### 4. 实时更新支持

- 支持增量索引更新
- 动态添加新的文档、逻辑单元或块
- 实时更新向量索引

### 5. 扩展性设计

- 支持水平扩展，可部署在多台机器上
- 支持分布式查询
- 兼容UltraRAG的MCP架构

这个架构完全基于LanceDB实现，统一处理关键词、稠密和稀疏检索，同时支持您规划中的多粒度数据处理、灵活索引策略、检索优化和评估反馈机制。通过LanceDB的强大功能，可以实现高性能、可扩展的RAG系统。
